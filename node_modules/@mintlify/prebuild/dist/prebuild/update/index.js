import { outputFile } from 'fs-extra';
import { updateMintConfigFile } from './mintConfig/index.js';
import { readPageContents, readSnippetsV2Contents } from './read/readContent.js';
import { resolveImportsAndWriteFiles } from './resolveImportsAndWriteFiles.js';
import { updateFavicons } from './updateFavicons.js';
import { updateGeneratedNav } from './updateGeneratedNav.js';
import { writeFiles } from './write/writeFiles.js';
import { writeOpenApiFiles } from './write/writeOpenApiFiles.js';
export const update = async (contentDirectoryPath, staticFilenames, openApiFiles, contentFilenames, snippets, snippetV2Filenames) => {
    const { mintConfig, pagesAcc, openApiFiles: newOpenApiFiles, } = await updateMintConfigFile(contentDirectoryPath, openApiFiles);
    const pagePromises = readPageContents(contentDirectoryPath, openApiFiles, contentFilenames, pagesAcc);
    const snippetV2Promises = readSnippetsV2Contents(contentDirectoryPath, snippetV2Filenames);
    const [snippetV2Contents, { mdxFilesWithNoImports, filesWithImports }] = await Promise.all([
        snippetV2Promises,
        pagePromises,
    ]);
    await Promise.all([
        resolveImportsAndWriteFiles(openApiFiles, pagesAcc, snippetV2Contents, filesWithImports),
        writeOpenApiFiles(newOpenApiFiles),
        updateFavicons(mintConfig, contentDirectoryPath),
        ...writeMdxFilesWithNoImports(mdxFilesWithNoImports),
        ...writeFiles(contentDirectoryPath, 'public', [...staticFilenames, ...snippets]),
    ]);
    // needs to happen after resolveImportsAndWriteFiles b/c it's dependent on the files existing
    await updateGeneratedNav(pagesAcc, mintConfig.navigation);
    return mintConfig;
};
export const writeMdxFilesWithNoImports = (mdxFilesWithNoImports) => {
    return mdxFilesWithNoImports.map(async (response) => {
        const { targetPath, fileContent } = response;
        await outputFile(targetPath, fileContent, {
            flag: 'w',
        });
    });
};
export * from './mintConfig/index.js';
export { getOpenApiDocumentFromUrl } from './read/getOpenApiFilesFromMintConfig.js';
